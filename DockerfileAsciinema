FROM asciinema/asciinema
WORKDIR /app

FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build

ARG ARTIFACTS_ENDPOINT
ARG ACCESS_TOKEN
ARG USER

WORKDIR /src

COPY ["src/HttpExecutor/HttpExecutor.csproj", "src/HttpExecutor/"]
COPY ["src/HttpExecutor.Abstractions/HttpExecutor.Abstractions.csproj", "src/HttpExecutor/"]
COPY ["src/HttpExecutor.Ioc/HttpExecutor.Ioc.csproj", "src/HttpExecutor/"]
COPY ["src/HttpExecutor.Services/HttpExecutor.Services.csproj", "src/HttpExecutor/"]

RUN echo "<?xml version='1.0' encoding='utf-8'?><configuration><packageSources><add key='apiway' value='$ARTIFACTS_ENDPOINT' /></packageSources><packageSourceCredentials><apiway><add key='Username' value='$USER' /><add key='ClearTextPassword' value='$ACCESS_TOKEN' /></apiway></packageSourceCredentials></configuration>" > NuGet.Config

RUN dotnet restore "src/HttpExecutor/HttpExecutor.csproj"
COPY . .
WORKDIR "/src/src/HttpExecutor"
RUN dotnet build "HttpExecutor.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "HttpExecutor.csproj" -c Release -o /app/publish -r linux-x64 --self-contained false

FROM asciinema/asciinema AS final

RUN apt-get update; \
  apt-get install -y wget

RUN wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
RUN dpkg -i packages-microsoft-prod.deb
RUN apt-get update; \
  apt-get install -y apt-transport-https && \
  apt-get update && \
  apt-get install -y aspnetcore-runtime-5.0

WORKDIR /app

COPY --from=publish /app/publish .
COPY --from=build /src/httpbingo.http ./httpbingo.http